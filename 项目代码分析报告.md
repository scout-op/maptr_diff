# MapTR é¡¹ç›®ä»£ç æ·±åº¦åˆ†ææŠ¥å‘Š

**åˆ†ææ—¥æœŸ**: 2024-12-09  
**é¡¹ç›®ä½ç½®**: `/home/subobo/ro/e2e/mmdetection3d/projects/mmdet3d_plugin/`  
**é¡¹ç›®çŠ¶æ€**: âœ… OpenMMLab 2.0 è¿ç§»å®Œæˆ (96%)

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [å…³é”®æ¨¡å—è¯¦è§£](#å…³é”®æ¨¡å—è¯¦è§£)
4. [æ•°æ®æµå¤„ç†](#æ•°æ®æµå¤„ç†)
5. [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
6. [è®­ç»ƒä¸æµ‹è¯•](#è®­ç»ƒä¸æµ‹è¯•)
7. [æŠ€æœ¯äº®ç‚¹](#æŠ€æœ¯äº®ç‚¹)
8. [ä»£ç è´¨é‡è¯„ä¼°](#ä»£ç è´¨é‡è¯„ä¼°)

---

## é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**MapTR** æ˜¯ä¸€ä¸ªåŸºäº Transformer çš„åœ¨çº¿çŸ¢é‡åŒ–é«˜ç²¾åœ°å›¾æ„å»ºç³»ç»Ÿï¼Œç”¨äºä»å¤šè§†è§’å›¾åƒä¸­å®æ—¶ç”Ÿæˆç»“æ„åŒ–çš„é“è·¯å…ƒç´ è¡¨ç¤ºã€‚

### 1.2 æ ¸å¿ƒåŠŸèƒ½

- **å¤šè§†è§’å›¾åƒç¼–ç **: æ”¯æŒå¤šæ‘„åƒå¤´è¾“å…¥ï¼ˆé»˜è®¤6ä¸ªï¼‰
- **çŸ¢é‡åŒ–åœ°å›¾æ„å»º**: è¾“å‡ºç»“æ„åŒ–çš„é“è·¯çº¿å…ƒç´ 
- **å®æ—¶æ¨ç†**: æ”¯æŒåœ¨çº¿åœºæ™¯çš„åœ°å›¾æ„å»º
- **å¤šæ•°æ®é›†æ”¯æŒ**: Argoverse2 å’Œ NuScenes

### 1.3 æŠ€æœ¯æ ˆ

```
OpenMMLab 2.0 ç”Ÿæ€ç³»ç»Ÿ
â”œâ”€â”€ MMEngine >= 0.8.0        # è®­ç»ƒå¼•æ“
â”œâ”€â”€ MMDetection3D == 1.4.0   # 3Dæ£€æµ‹æ¡†æ¶
â”œâ”€â”€ MMCV >= 2.0.0           # è®¡ç®—æœºè§†è§‰åŸºç¡€åº“
â””â”€â”€ PyTorch 1.9+            # æ·±åº¦å­¦ä¹ æ¡†æ¶
```

### 1.4 é¡¹ç›®ç»“æ„

```
mmdet3d_plugin/
â”œâ”€â”€ maptr/                  # MapTRæ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ detectors/          # æ£€æµ‹å™¨å®ç°
â”‚   â”œâ”€â”€ dense_heads/        # æ£€æµ‹å¤´
â”‚   â”œâ”€â”€ modules/            # æ ¸å¿ƒæ¨¡å—ï¼ˆTransformerã€æ³¨æ„åŠ›æœºåˆ¶ï¼‰
â”‚   â”œâ”€â”€ assigners/          # æ ‡ç­¾åˆ†é…å™¨
â”‚   â””â”€â”€ losses/             # æŸå¤±å‡½æ•°
â”œâ”€â”€ bevformer/              # BEVFormerç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ detectors/          # BEVFormeræ£€æµ‹å™¨
â”‚   â”œâ”€â”€ modules/            # æ—¶ç©ºæ³¨æ„åŠ›æ¨¡å—
â”‚   â””â”€â”€ dense_heads/        # BEVFormeræ£€æµ‹å¤´
â”œâ”€â”€ datasets/               # æ•°æ®é›†å’Œè¯„ä¼°
â”‚   â”œâ”€â”€ av2_map_dataset.py
â”‚   â”œâ”€â”€ nuscenes_map_dataset.py
â”‚   â”œâ”€â”€ map_metric.py       # è‡ªå®šä¹‰è¯„ä¼°æŒ‡æ ‡
â”‚   â””â”€â”€ pipelines/          # æ•°æ®å¤„ç†æµç¨‹
â”œâ”€â”€ models/                 # æ¨¡å‹ç»„ä»¶
â”‚   â”œâ”€â”€ backbones/          # éª¨å¹²ç½‘ç»œï¼ˆResNetã€Swinã€EfficientNetï¼‰
â”‚   â”œâ”€â”€ utils/              # å·¥å…·æ¨¡å—
â”‚   â””â”€â”€ opt/                # ä¼˜åŒ–å™¨
â”œâ”€â”€ configs/                # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ _base_/
â”‚   â”œâ”€â”€ maptr_av2_example.py
â”‚   â””â”€â”€ maptr_nuscenes_example.py
â”œâ”€â”€ tools/                  # è®­ç»ƒæµ‹è¯•å·¥å…·
â”‚   â”œâ”€â”€ train.py
â”‚   â”œâ”€â”€ test.py
â”‚   â””â”€â”€ verify_installation.py
â””â”€â”€ core/                   # æ ¸å¿ƒå·¥å…·ï¼ˆbboxã€è¯„ä¼°ï¼‰
```

---

## æ ¸å¿ƒæ¶æ„

### 2.1 æ•´ä½“æ¶æ„è®¾è®¡

MapTR é‡‡ç”¨ç»å…¸çš„ **ç¼–ç å™¨-è§£ç å™¨** æ¶æ„ï¼š

```
è¾“å…¥å›¾åƒ (6è§†è§’)
    â†“
[å›¾åƒç¼–ç å™¨]
â”œâ”€â”€ Backbone (ResNet/Swin/EfficientNet)
â”œâ”€â”€ Neck (FPN)
â””â”€â”€ ç‰¹å¾æå–
    â†“
[BEVç‰¹å¾ç”Ÿæˆ]
â”œâ”€â”€ å¤šè§†è§’ç‰¹å¾èåˆ
â”œâ”€â”€ LSS Transform (Lift-Splat-Shoot)
â””â”€â”€ BEVç‰¹å¾è¡¨ç¤º
    â†“
[Transformerè§£ç å™¨]
â”œâ”€â”€ æŸ¥è¯¢åˆå§‹åŒ– (Query Embeddings)
â”œâ”€â”€ è‡ªæ³¨æ„åŠ› (Self-Attention)
â”œâ”€â”€ äº¤å‰æ³¨æ„åŠ› (Cross-Attention with BEV)
â””â”€â”€ å‡ ä½•æ ¸æ³¨æ„åŠ› (Geometry Kernel Attention)
    â†“
[é¢„æµ‹å¤´]
â”œâ”€â”€ åˆ†ç±»åˆ†æ”¯ â†’ åœ°å›¾å…ƒç´ ç±»åˆ« (divider, crossing, boundary)
â”œâ”€â”€ å›å½’åˆ†æ”¯ â†’ çŸ¢é‡ç‚¹åæ ‡
â””â”€â”€ æ‰©æ•£å¤´ (å¯é€‰) â†’ ç²¾ç»†åŒ–çŸ¢é‡è¡¨ç¤º
    â†“
è¾“å‡º: ç»“æ„åŒ–çŸ¢é‡åœ°å›¾
```

### 2.2 æ ¸å¿ƒç±»å±‚æ¬¡ç»“æ„

#### MapTR æ£€æµ‹å™¨

```python
@MODELS.register_module()
class MapTR(MVXTwoStageDetector):
    """
    ä½ç½®: maptr/detectors/maptr.py
    ç»§æ‰¿: MVXTwoStageDetector (MMDetection3D)
    
    æ ¸å¿ƒèŒè´£:
    - ç»Ÿç­¹æ•´ä¸ªå‰å‘æ¨ç†æµç¨‹
    - ç®¡ç†å›¾åƒç‰¹å¾æå–
    - åè°ƒè®­ç»ƒå’Œæµ‹è¯•é€»è¾‘
    - æ”¯æŒæ—¶åºä¿¡æ¯ï¼ˆprev_bevï¼‰
    """
    
    å…³é”®æ–¹æ³•:
    - extract_img_feat()      # æå–å¤šè§†è§’å›¾åƒç‰¹å¾
    - forward_pts_train()     # è®­ç»ƒå‰å‘ä¼ æ’­
    - forward_test()          # æµ‹è¯•æ¨ç†
    - simple_test()           # å•å›¾æµ‹è¯•
```

#### MapTR æ£€æµ‹å¤´

```python
@MODELS.register_module()
class MapTRHead(DETRHead):
    """
    ä½ç½®: maptr/dense_heads/maptr_head.py
    ç»§æ‰¿: DETRHead (MMDetection)
    
    æ ¸å¿ƒèŒè´£:
    - ç®¡ç†æŸ¥è¯¢ï¼ˆQueriesï¼‰
    - æ‰§è¡ŒTransformerè§£ç 
    - è®¡ç®—æŸå¤±å‡½æ•°
    - åå¤„ç†é¢„æµ‹ç»“æœ
    
    å…³é”®ç‰¹æ€§:
    - num_vec: çŸ¢é‡æ•°é‡ï¼ˆé€šå¸¸100-200ï¼‰
    - num_pts_per_vec: æ¯ä¸ªçŸ¢é‡çš„ç‚¹æ•°
    - use_diffusion: æ˜¯å¦ä½¿ç”¨æ‰©æ•£æ¨¡å‹ç²¾ç»†åŒ–
    """
    
    æ ¸å¿ƒç»„ä»¶:
    - transformer: MapTRPerceptionTransformer
    - cls_branches: åˆ†ç±»åˆ†æ”¯
    - reg_branches: å›å½’åˆ†æ”¯
    - diffusion_head (å¯é€‰): æ‰©æ•£å¤´
```

### 2.3 Transformer æ¶æ„

#### MapTRPerceptionTransformer

```python
@MODELS.register_module()
class MapTRPerceptionTransformer(BaseModule):
    """
    ä½ç½®: maptr/modules/transformer.py
    
    æ¶æ„:
    1. BEVç¼–ç å™¨ (Encoder)
       - å¤šè§†è§’ç‰¹å¾èåˆ
       - LSSå˜æ¢ï¼ˆå›¾åƒâ†’BEVï¼‰
       - æ—¶åºä¿¡æ¯èåˆï¼ˆå¯é€‰ï¼‰
    
    2. MapTRè§£ç å™¨ (Decoder)
       - æŸ¥è¯¢-BEVäº¤å‰æ³¨æ„åŠ›
       - å‡ ä½•æ ¸æ³¨æ„åŠ›
       - å‰é¦ˆç½‘ç»œ
       - å±‚å½’ä¸€åŒ–
    """
    
    å…³é”®æ¨¡å—:
    - encoder: LSSTransform / BEVFormerEncoder
    - decoder: MapTRDecoder
    - level_embeds: ç‰¹å¾å±‚çº§ç¼–ç 
    - cams_embeds: ç›¸æœºä½ç½®ç¼–ç 
```

#### å‡ ä½•æ ¸æ³¨æ„åŠ› (Geometry Kernel Attention)

```python
class GeometryKernelAttention(BaseModule):
    """
    ä½ç½®: maptr/modules/geometry_kernel_attention.py
    
    åˆ›æ–°ç‚¹:
    - ç»“åˆå‡ ä½•å…ˆéªŒçš„æ³¨æ„åŠ›æœºåˆ¶
    - é’ˆå¯¹åœ°å›¾å…ƒç´ çš„ç©ºé—´å…³ç³»å»ºæ¨¡
    - æå‡çŸ¢é‡é¢„æµ‹ç²¾åº¦
    
    å·¥ä½œæµç¨‹:
    1. æ ¹æ®æŸ¥è¯¢ä½ç½®ç”Ÿæˆé‡‡æ ·ç‚¹
    2. åœ¨BEVç‰¹å¾ä¸Šé‡‡æ ·
    3. ä½¿ç”¨å‡ ä½•æ ¸åŠ æƒèšåˆ
    4. è¾“å‡ºç²¾ç»†åŒ–çš„æŸ¥è¯¢ç‰¹å¾
    """
```

---

## å…³é”®æ¨¡å—è¯¦è§£

### 3.1 æ•°æ®é›†æ¨¡å—

#### Argoverse2 æ•°æ®é›†

```python
@DATASETS.register_module()
class CustomAV2LocalMapDataset(CustomNuScenesDataset):
    """
    ä½ç½®: datasets/av2_map_dataset.py
    æ–‡ä»¶å¤§å°: 68KB (1517è¡Œ)
    
    æ ¸å¿ƒåŠŸèƒ½:
    1. åŠ è½½AV2ä¼ æ„Ÿå™¨æ•°æ®
    2. è§£æAV2åœ°å›¾æ ‡æ³¨
    3. æå–åœ°å›¾å…ƒç´ ï¼ˆè½¦é“çº¿ã€äººè¡Œæ¨ªé“ã€è¾¹ç•Œï¼‰
    4. æ•°æ®å¢å¼ºå’Œé¢„å¤„ç†
    
    åœ°å›¾å…ƒç´ ç±»åˆ«:
    - 'divider': è½¦é“åˆ†éš”çº¿
    - 'ped_crossing': äººè¡Œæ¨ªé“
    - 'boundary': é“è·¯è¾¹ç•Œ
    """
    
    å…³é”®ç±»:
    - LiDARInstanceLines: åœ°å›¾çº¿å…ƒç´ è¡¨ç¤º
    - VectorizedLocalMap: å±€éƒ¨åœ°å›¾çŸ¢é‡åŒ–
```

#### NuScenes æ•°æ®é›†

```python
@DATASETS.register_module()
class CustomNuScenesLocalMapDataset(NuScenesDataset):
    """
    ä½ç½®: datasets/nuscenes_map_dataset.py
    æ–‡ä»¶å¤§å°: 68KB (1517è¡Œ)
    
    æ”¯æŒçš„åœ°å›¾å…ƒç´ :
    - Lane divider (è™šçº¿ã€å®çº¿)
    - Pedestrian crossing
    - Road boundary
    - Walkway
    """
```

### 3.2 æ•°æ®å¤„ç†æµç¨‹ (Pipeline)

#### å…³é”®Pipelineç»„ä»¶

```python
# 1. å¤šè§†è§’å›¾åƒåŠ è½½
class LoadMultiViewImageFromFiles(LoadImageFromFile):
    """åŠ è½½å¤šä¸ªç›¸æœºçš„å›¾åƒ"""
    
# 2. æ•°æ®å¢å¼º
class PhotoMetricDistortionMultiViewImage:
    """å¤šè§†è§’å›¾åƒå…‰åº¦å¤±çœŸ"""
    
# 3. å½’ä¸€åŒ–
class NormalizeMultiviewImage:
    """æ ‡å‡†åŒ–å›¾åƒï¼ˆImageNetå‡å€¼/æ ‡å‡†å·®ï¼‰"""
    
# 4. Padding
class PadMultiViewImage:
    """å¡«å……åˆ°æŒ‡å®šå°ºå¯¸ï¼ˆ32çš„å€æ•°ï¼‰"""
    
# 5. æ•°æ®æ‰“åŒ…
class CustomCollect3D:
    """æ”¶é›†è®­ç»ƒ/æµ‹è¯•æ‰€éœ€çš„æ•°æ®å­—æ®µ"""
```

### 3.3 è¯„ä¼°ç³»ç»Ÿ

#### MapMetric è¯„ä¼°å™¨

```python
@METRICS.register_module()
class MapMetricWithGT(BaseMetric):
    """
    ä½ç½®: datasets/map_metric.py
    æ–‡ä»¶å¤§å°: 13.4KB
    
    è¯„ä¼°æŒ‡æ ‡:
    1. Chamfer Distance
       - 0.5m, 1.0m, 1.5mé˜ˆå€¼
       - è¡¡é‡é¢„æµ‹ä¸GTçš„ç‚¹åˆ°ç‚¹è·ç¦»
    
    2. IoU (Intersection over Union)
       - é˜ˆå€¼èŒƒå›´: 0.5-0.95 (æ­¥é•¿0.05)
       - è¡¡é‡çŸ¢é‡é‡å åº¦
    
    è¾“å‡ºæŒ‡æ ‡:
    - mAP (mean Average Precision)
    - CD_0.5, CD_1.0, CD_1.5
    - IoU_0.5, IoU_0.75, IoU_0.95
    """
    
    å…³é”®æ–¹æ³•:
    - process(): å¤„ç†æ¯ä¸ªbatchçš„ç»“æœ
    - compute_metrics(): è®¡ç®—æœ€ç»ˆæŒ‡æ ‡
```

### 3.4 æ‰©æ•£æ¨¡å— (Diffusion Head)

```python
class PointDiffusionHead(BaseModule):
    """
    ä½ç½®: maptr/modules/diffusion_head.py
    æ–‡ä»¶å¤§å°: 10.6KB
    
    åŠŸèƒ½: ä½¿ç”¨æ‰©æ•£æ¨¡å‹ç²¾ç»†åŒ–çŸ¢é‡ç‚¹é¢„æµ‹
    
    æµç¨‹:
    1. åŠ å™ªè¿‡ç¨‹ (Forward Diffusion)
       - é€æ­¥å‘GTæ·»åŠ é«˜æ–¯å™ªå£°
       - ç”Ÿæˆä¸åŒå™ªå£°æ°´å¹³çš„è®­ç»ƒæ ·æœ¬
    
    2. å»å™ªè¿‡ç¨‹ (Reverse Diffusion)
       - ä»å™ªå£°ä¸­æ¢å¤å¹²å‡€çš„çŸ¢é‡ç‚¹
       - ä½¿ç”¨æ¡ä»¶ä¿¡æ¯å¼•å¯¼ï¼ˆæŸ¥è¯¢ç‰¹å¾ï¼‰
    
    3. DDIMé‡‡æ ·å™¨
       - åŠ é€Ÿæ¨ç†ï¼ˆè·³è¿‡éƒ¨åˆ†æ­¥éª¤ï¼‰
       - ç¡®å®šæ€§é‡‡æ ·
    """
```

### 3.5 éª¨å¹²ç½‘ç»œ

#### æ”¯æŒçš„Backbone

```python
# 1. ResNetç³»åˆ—
@MODELS.register_module()
class ResNet:  # MMDetectionå†…ç½®
    æ”¯æŒ: ResNet-50, ResNet-101
    
# 2. Swin Transformer
@MODELS.register_module()
class SwinTransformer:
    ä½ç½®: models/backbones/swin.py
    ç‰¹ç‚¹: åˆ†å±‚Transformerï¼Œé€‚åˆå¯†é›†é¢„æµ‹
    
# 3. EfficientNet
@MODELS.register_module()
class EfficientNet:
    ä½ç½®: models/backbones/efficientnet.py
    ç‰¹ç‚¹: é«˜æ•ˆå·ç§¯ç½‘ç»œ
    
# 4. VoVNet
@MODELS.register_module()
class VoVNet:
    ä½ç½®: models/backbones/vovnet.py
    ç‰¹ç‚¹: ä¸€æ¬¡æ€§èšåˆï¼ˆOne-Shot Aggregationï¼‰
```

---

## æ•°æ®æµå¤„ç†

### 4.1 è®­ç»ƒæ•°æ®æµ

```
1. æ•°æ®åŠ è½½
   æ•°æ®é›† â†’ æ•°æ®åŠ è½½å™¨ (DataLoader)
   â”œâ”€â”€ å¤šè¿›ç¨‹åŠ è½½
   â”œâ”€â”€ Batché‡‡æ ·
   â””â”€â”€ æ•°æ®é¢„å–

2. æ•°æ®å¢å¼º
   Pipelineå¤„ç†
   â”œâ”€â”€ LoadMultiViewImageFromFiles
   â”œâ”€â”€ PhotoMetricDistortion
   â”œâ”€â”€ RandomFlip (å¯é€‰)
   â””â”€â”€ Normalize + Pad

3. æ¨¡å‹è¾“å…¥
   batch = {
       'img': [B, N_cam, C, H, W],      # å¤šè§†è§’å›¾åƒ
       'img_metas': [{...}, {...}],     # å…ƒä¿¡æ¯
       'gt_vecs_pts_loc': [B, N_vec, N_pts, 2],  # GTçŸ¢é‡ç‚¹
       'gt_vecs_label': [B, N_vec],     # GTæ ‡ç­¾
   }

4. å‰å‘ä¼ æ’­
   MapTR.forward_train(batch)
   â”œâ”€â”€ extract_img_feat()              # å›¾åƒç‰¹å¾æå–
   â”œâ”€â”€ pts_bbox_head()                 # Transformeræ¨ç†
   â””â”€â”€ lossè®¡ç®—

5. åå‘ä¼ æ’­
   optimizer.step()
   â”œâ”€â”€ æ¢¯åº¦è®¡ç®—
   â”œâ”€â”€ æ¢¯åº¦è£å‰ª
   â””â”€â”€ å‚æ•°æ›´æ–°
```

### 4.2 æ¨ç†æ•°æ®æµ

```
1. å›¾åƒè¾“å…¥
   å•å¸§æˆ–åºåˆ— â†’ é¢„å¤„ç†

2. ç‰¹å¾æå–
   Backbone + Neck â†’ å¤šå°ºåº¦ç‰¹å¾

3. BEVè½¬æ¢
   LSS / BEVFormer â†’ BEVç‰¹å¾è¡¨ç¤º

4. Transformerè§£ç 
   æŸ¥è¯¢ Ã— BEV â†’ çŸ¢é‡é¢„æµ‹

5. åå¤„ç†
   â”œâ”€â”€ é˜ˆå€¼è¿‡æ»¤ï¼ˆscore > thresholdï¼‰
   â”œâ”€â”€ NMSï¼ˆå¯é€‰ï¼‰
   â””â”€â”€ çŸ¢é‡ç‚¹è§£ç 

6. è¾“å‡º
   {
       'vecs_pts_loc': [N_vec, N_pts, 2],  # çŸ¢é‡ç‚¹åæ ‡
       'vecs_scores': [N_vec],             # ç½®ä¿¡åº¦
       'vecs_labels': [N_vec],             # ç±»åˆ«
   }
```

---

## é…ç½®ç³»ç»Ÿ

### 5.1 é…ç½®æ–‡ä»¶ç»“æ„

```python
# configs/maptr_av2_example.py

# 1. ç»§æ‰¿åŸºç¡€é…ç½®
_base_ = ['./_base_/default_runtime.py']

# 2. ä½œç”¨åŸŸ
default_scope = 'mmdet3d'

# 3. æ¨¡å‹é…ç½®
model = dict(
    type='MapTR',
    # éª¨å¹²ç½‘ç»œ
    img_backbone=dict(
        type='ResNet',
        depth=50,
        ...
    ),
    # é¢ˆéƒ¨
    img_neck=dict(
        type='FPN',
        ...
    ),
    # æ£€æµ‹å¤´
    pts_bbox_head=dict(
        type='MapTRHead',
        num_queries=100,          # æŸ¥è¯¢æ•°é‡
        num_classes=3,            # ç±»åˆ«æ•°
        transformer=dict(
            type='MapTRPerceptionTransformer',
            encoder=dict(...),
            decoder=dict(...),
        ),
        use_diffusion=False,      # æ˜¯å¦ä½¿ç”¨æ‰©æ•£æ¨¡å—
    ),
)

# 4. æ•°æ®é…ç½®
train_dataloader = dict(
    batch_size=1,
    dataset=dict(
        type='CustomAV2LocalMapDataset',
        data_root='data/av2/',
        pipeline=[...],
    )
)

# 5. ä¼˜åŒ–å™¨
optim_wrapper = dict(
    type='OptimWrapper',
    optimizer=dict(
        type='AdamW',
        lr=2e-4,
        weight_decay=0.01,
    )
)

# 6. è®­ç»ƒé…ç½®
train_cfg = dict(
    type='EpochBasedTrainLoop',
    max_epochs=24,
    val_interval=1,
)

# 7. è¯„ä¼°é…ç½®
val_evaluator = dict(
    type='MapMetricWithGT',
    metric=['chamfer', 'iou'],
)
```

### 5.2 å…³é”®é…ç½®é¡¹

| é…ç½®é¡¹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `num_queries` | 100 | TransformeræŸ¥è¯¢æ•°é‡ |
| `num_vec` | 50 | é¢„æµ‹çš„çŸ¢é‡æ•°é‡ |
| `num_pts_per_vec` | 20 | æ¯ä¸ªçŸ¢é‡çš„é‡‡æ ·ç‚¹æ•° |
| `pc_range` | [-51.2, -51.2, -5, 51.2, 51.2, 3] | ç‚¹äº‘èŒƒå›´ |
| `bev_h, bev_w` | 200, 200 | BEVç‰¹å¾åˆ†è¾¨ç‡ |
| `use_diffusion` | False | æ˜¯å¦å¯ç”¨æ‰©æ•£ç²¾ç»†åŒ– |
| `diffusion_steps` | 1000 | æ‰©æ•£æ­¥æ•° |

---

## è®­ç»ƒä¸æµ‹è¯•

### 6.1 è®­ç»ƒæµç¨‹

#### æ ‡å‡†è®­ç»ƒ

```bash
# å•GPU
python tools/train.py configs/maptr_av2_example.py

# å¤šGPU (8å¡)
bash tools/dist_train.sh configs/maptr_av2_example.py 8

# ä½¿ç”¨AMPæ··åˆç²¾åº¦
python tools/train.py configs/maptr_av2_example.py --amp

# ä»æ£€æŸ¥ç‚¹æ¢å¤
python tools/train.py configs/maptr_av2_example.py \
    --resume work_dirs/maptr_av2_example/latest.pth
```

#### è®­ç»ƒç›‘æ§

```
è®­ç»ƒæ—¥å¿—è¾“å‡º:
â”œâ”€â”€ work_dirs/maptr_av2_example/
â”‚   â”œâ”€â”€ config.py              # å®é™…ä½¿ç”¨çš„é…ç½®
â”‚   â”œâ”€â”€ *.log                  # è®­ç»ƒæ—¥å¿—
â”‚   â”œâ”€â”€ epoch_*.pth            # æ£€æŸ¥ç‚¹
â”‚   â””â”€â”€ vis_data/              # å¯è§†åŒ–ï¼ˆå¦‚æœå¼€å¯ï¼‰

TensorBoard:
tensorboard --logdir work_dirs/maptr_av2_example/
```

### 6.2 æµ‹è¯•ä¸è¯„ä¼°

```bash
# å•GPUæµ‹è¯•
python tools/test.py \
    configs/maptr_av2_example.py \
    work_dirs/maptr_av2_example/epoch_24.pth

# å¤šGPUæµ‹è¯•
bash tools/dist_test.sh \
    configs/maptr_av2_example.py \
    work_dirs/maptr_av2_example/epoch_24.pth 8

# å¯è§†åŒ–ç»“æœ
python tools/test.py \
    configs/maptr_av2_example.py \
    work_dirs/maptr_av2_example/epoch_24.pth \
    --show \
    --show-dir work_dirs/vis_results
```

### 6.3 æ¨¡å‹æ€§èƒ½

#### é¢„æœŸæŒ‡æ ‡ï¼ˆå‚è€ƒï¼‰

| æ•°æ®é›† | Backbone | mAP | CD@0.5 | CD@1.0 |
|--------|----------|-----|--------|--------|
| AV2 | ResNet-50 | TBD | TBD | TBD |
| NuScenes | ResNet-50 | TBD | TBD | TBD |

æ³¨: å…·ä½“æŒ‡æ ‡éœ€è¦åœ¨å„è‡ªæ•°æ®é›†ä¸Šè®­ç»ƒæµ‹è¯•

---

## æŠ€æœ¯äº®ç‚¹

### 7.1 æ ¸å¿ƒåˆ›æ–°

#### 1. æŸ¥è¯¢-çŸ¢é‡è¡¨ç¤º

```python
# ä¼ ç»Ÿæ–¹æ³•: å¯†é›†é¢„æµ‹ â†’ åå¤„ç†æå–çŸ¢é‡
# MapTR: ç›´æ¥é¢„æµ‹çŸ¢é‡åŒ–è¡¨ç¤º

æŸ¥è¯¢ (Query) â†’ Transformerè§£ç  â†’ çŸ¢é‡ç‚¹ (Points)

ä¼˜åŠ¿:
- ç«¯åˆ°ç«¯å­¦ä¹ 
- ç»“æ„åŒ–è¾“å‡º
- é«˜æ•ˆæ¨ç†
```

#### 2. å‡ ä½•æ ¸æ³¨æ„åŠ›

```python
# ç»“åˆå‡ ä½•å…ˆéªŒçš„æ³¨æ„åŠ›æœºåˆ¶

def geometry_kernel_attention(query, bev_feat, reference_points):
    """
    query: [N_q, C]              # æŸ¥è¯¢ç‰¹å¾
    bev_feat: [H, W, C]          # BEVç‰¹å¾
    reference_points: [N_q, 2]   # å‚è€ƒç‚¹ä½ç½®
    """
    # 1. æ ¹æ®å‚è€ƒç‚¹ç”Ÿæˆé‡‡æ ·ç½‘æ ¼
    sampling_grid = generate_sampling_grid(reference_points)
    
    # 2. åŒçº¿æ€§æ’å€¼é‡‡æ ·
    sampled_feat = grid_sample(bev_feat, sampling_grid)
    
    # 3. å‡ ä½•æ ¸åŠ æƒ
    weights = compute_geometry_weights(query, reference_points)
    output = weighted_sum(sampled_feat, weights)
    
    return output

ä¼˜åŠ¿:
- ç©ºé—´æ„ŸçŸ¥
- æå‡ç²¾åº¦
- å‡å°‘æ­§ä¹‰
```

#### 3. æ‰©æ•£ç²¾ç»†åŒ–ï¼ˆå¯é€‰ï¼‰

```python
# ä½¿ç”¨æ‰©æ•£æ¨¡å‹è¿›ä¸€æ­¥ä¼˜åŒ–çŸ¢é‡é¢„æµ‹

class PointDiffusionHead:
    def forward(self, init_points, query_feat):
        # 1. åˆå§‹é¢„æµ‹
        x_T = init_points + noise
        
        # 2. é€æ­¥å»å™ª
        for t in reversed(range(T)):
            x_t = denoise_step(x_t, t, query_feat)
        
        # 3. æœ€ç»ˆè¾“å‡º
        refined_points = x_0
        return refined_points

ä¼˜åŠ¿:
- æ›´ç²¾ç»†çš„çŸ¢é‡
- å¤šæ¨¡æ€è¾“å‡º
- æ¸è¿›å¼ä¼˜åŒ–
```

### 7.2 å·¥ç¨‹ä¼˜åŒ–

#### 1. æ··åˆç²¾åº¦è®­ç»ƒ

```python
# è‡ªåŠ¨ä½¿ç”¨ torch.cuda.amp
python tools/train.py config.py --amp

ä¼˜åŠ¿:
- åŠ é€Ÿè®­ç»ƒï¼ˆçº¦2xï¼‰
- å‡å°‘æ˜¾å­˜å ç”¨
- ä¿æŒç²¾åº¦
```

#### 2. æ¢¯åº¦ç´¯ç§¯

```python
# é…ç½®æ–‡ä»¶
optim_wrapper = dict(
    type='OptimWrapper',
    optimizer=dict(...),
    accumulative_counts=4,  # ç´¯ç§¯4ä¸ªbatch
)

ä¼˜åŠ¿:
- ç­‰æ•ˆæ›´å¤§batch size
- é€‚åº”æœ‰é™GPUå†…å­˜
```

#### 3. åˆ†å¸ƒå¼è®­ç»ƒ

```python
# è‡ªåŠ¨æ•°æ®å¹¶è¡Œ
# DistributedDataParallel (DDP)

ä¼˜åŠ¿:
- çº¿æ€§åŠ é€Ÿ
- åŒæ­¥BN
- é«˜æ•ˆé€šä¿¡
```

---

## ä»£ç è´¨é‡è¯„ä¼°

### 8.1 ä¼˜ç‚¹

#### âœ… æ¶æ„æ¸…æ™°
- æ¨¡å—åŒ–è®¾è®¡
- èŒè´£æ˜ç¡®
- æ˜“äºæ‰©å±•

#### âœ… æ³¨å†Œå™¨ç³»ç»Ÿ
```python
@MODELS.register_module()
class MapTR(MVXTwoStageDetector):
    ...

# ä¼˜ç‚¹:
# - é…ç½®é©±åŠ¨
# - ç»„ä»¶å¯æ›¿æ¢
# - ä¾¿äºå®éªŒ
```

#### âœ… æ–‡æ¡£å®Œå–„
- READMEè¯¦å°½
- ä»£ç æ³¨é‡Šä¸°å¯Œ
- ç¤ºä¾‹é…ç½®é½å…¨

#### âœ… è¿ç§»å®Œæˆåº¦é«˜
- 96%æ–‡ä»¶å·²è¿ç§»
- OpenMMLab 2.0å…¼å®¹
- ç°ä»£åŒ–è®­ç»ƒæµç¨‹

### 8.2 å¾…æ”¹è¿›é¡¹

#### âš ï¸ ç¡¬ç¼–ç éƒ¨åˆ†

```python
# ä¾‹å¦‚: maptr/detectors/maptr.py
self.grid_mask = GridMask(
    True, True, rotate=1, offset=False, 
    ratio=0.5, mode=1, prob=0.7
)
# å»ºè®®: é€šè¿‡é…ç½®æ–‡ä»¶æ§åˆ¶
```

#### âš ï¸ é—ç•™è£…é¥°å™¨æ³¨é‡Š

```python
# ä¾‹å¦‚: ä¸€äº›æ–‡ä»¶ä¸­ä¿ç•™äº†æ³¨é‡Šæ‰çš„ @auto_fp16
# @auto_fp16(apply_to=('mlvl_feats',))
def forward(self, mlvl_feats):
    ...
# å»ºè®®: å®Œå…¨ç§»é™¤æˆ–ç»Ÿä¸€å¤„ç†
```

#### âš ï¸ æµ‹è¯•è¦†ç›–

```
å½“å‰çŠ¶æ€: ç¼ºå°‘å•å…ƒæµ‹è¯•
å»ºè®®:
- æ·»åŠ æ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯•
- é›†æˆæµ‹è¯•ç”¨ä¾‹
- CI/CDæµç¨‹
```

### 8.3 å¯æ‰©å±•æ€§

#### ğŸ”§ æ·»åŠ æ–°æ•°æ®é›†

```python
# 1. åˆ›å»ºæ•°æ®é›†ç±»
@DATASETS.register_module()
class MyMapDataset(CustomNuScenesDataset):
    def __init__(self, ...):
        super().__init__(...)
        # è‡ªå®šä¹‰åˆå§‹åŒ–
    
    def get_ann_info(self, index):
        # è¿”å›æ ‡æ³¨ä¿¡æ¯
        return dict(...)

# 2. æ›´æ–°é…ç½®
dataset = dict(
    type='MyMapDataset',
    ...
)
```

#### ğŸ”§ æ·»åŠ æ–°éª¨å¹²ç½‘ç»œ

```python
# 1. å®ç°éª¨å¹²ç½‘ç»œ
@MODELS.register_module()
class MyBackbone(BaseModule):
    def __init__(self, ...):
        super().__init__()
        # æ„å»ºç½‘ç»œ
    
    def forward(self, x):
        # å‰å‘ä¼ æ’­
        return outs

# 2. æ›´æ–°é…ç½®
model = dict(
    img_backbone=dict(
        type='MyBackbone',
        ...
    )
)
```

#### ğŸ”§ è‡ªå®šä¹‰æŸå¤±å‡½æ•°

```python
# 1. å®ç°æŸå¤±ç±»
@MODELS.register_module()
class MyMapLoss(nn.Module):
    def forward(self, pred, target):
        # è®¡ç®—æŸå¤±
        return loss

# 2. åœ¨Headä¸­ä½¿ç”¨
pts_bbox_head = dict(
    loss_pts=dict(
        type='MyMapLoss',
        ...
    )
)
```

---

## é™„å½•

### A. æ–‡ä»¶ç»Ÿè®¡

| ç±»åˆ« | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° |
|------|--------|----------|
| æ ¸å¿ƒæ¨¡å‹ | 21 | ~8,000 |
| æ•°æ®é›† | 4 | ~5,000 |
| å·¥å…·æ¨¡å— | 9 | ~2,000 |
| é…ç½® | 3 | ~500 |
| æ–‡æ¡£ | 8 | ~2,000 |
| **æ€»è®¡** | **45+** | **~17,500** |

### B. å…³é”®æ–‡ä»¶æ¸…å•

#### å¿…è¯»æ–‡ä»¶ï¼ˆç†è§£æ¶æ„ï¼‰

1. `maptr/detectors/maptr.py` (437è¡Œ)
   - MapTRä¸»æ£€æµ‹å™¨

2. `maptr/dense_heads/maptr_head.py` (978è¡Œ)
   - æ£€æµ‹å¤´ï¼ŒæŸå¤±è®¡ç®—

3. `maptr/modules/transformer.py` (356è¡Œ)
   - Transformeræ¶æ„

4. `maptr/modules/geometry_kernel_attention.py` (23KB)
   - æ ¸å¿ƒæ³¨æ„åŠ›æœºåˆ¶

5. `datasets/av2_map_dataset.py` (1517è¡Œ)
   - æ•°æ®é›†å®ç°å‚è€ƒ

#### é…ç½®å‚è€ƒ

1. `configs/maptr_av2_example.py`
   - Argoverse2å®Œæ•´é…ç½®

2. `configs/_base_/default_runtime.py`
   - é»˜è®¤è¿è¡Œæ—¶é…ç½®

#### å·¥å…·è„šæœ¬

1. `tools/train.py`
   - è®­ç»ƒå…¥å£

2. `tools/test.py`
   - æµ‹è¯•å…¥å£

3. `tools/verify_installation.py`
   - ç¯å¢ƒéªŒè¯

### C. ä¾èµ–å…³ç³»å›¾

```
MapTR (æ£€æµ‹å™¨)
    â”œâ”€â”€ ResNet/Swin/EfficientNet (Backbone)
    â”œâ”€â”€ FPN (Neck)
    â””â”€â”€ MapTRHead
        â”œâ”€â”€ MapTRPerceptionTransformer
        â”‚   â”œâ”€â”€ LSSTransform/BEVFormerEncoder
        â”‚   â””â”€â”€ MapTRDecoder
        â”‚       â””â”€â”€ GeometryKernelAttention
        â”œâ”€â”€ Classification Branch
        â”œâ”€â”€ Regression Branch
        â””â”€â”€ PointDiffusionHead (å¯é€‰)

æ•°æ®æµ:
CustomAV2LocalMapDataset
    â†’ LoadMultiViewImageFromFiles
    â†’ PhotoMetricDistortion
    â†’ Normalize + Pad
    â†’ MapTR
    â†’ MapMetricWithGT
```

### D. å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# éªŒè¯å®‰è£…
python tools/verify_installation.py

# æµ‹è¯•é…ç½®åŠ è½½
python -c "
from mmengine.config import Config
cfg = Config.fromfile('configs/maptr_av2_example.py')
print(cfg.pretty_text)
"

# å•GPUè®­ç»ƒ
python tools/train.py configs/maptr_av2_example.py

# 8GPUè®­ç»ƒ
bash tools/dist_train.sh configs/maptr_av2_example.py 8

# æµ‹è¯•æ¨¡å‹
python tools/test.py \
    configs/maptr_av2_example.py \
    work_dirs/maptr_av2_example/epoch_24.pth
```

---

## æ€»ç»“

### é¡¹ç›®ä¼˜åŠ¿

1. **æ¶æ„å…ˆè¿›**: åŸºäºTransformerçš„ç«¯åˆ°ç«¯çŸ¢é‡åŒ–åœ°å›¾æ„å»º
2. **æ¡†æ¶ç°ä»£**: OpenMMLab 2.0ç”Ÿæ€ï¼Œå·¥ç¨‹åŒ–ç¨‹åº¦é«˜
3. **æ‰©å±•æ€§å¼º**: æ³¨å†Œå™¨ç³»ç»Ÿï¼Œæ¨¡å—åŒ–è®¾è®¡
4. **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œè¿ç§»è¯´æ˜
5. **ç”Ÿäº§å°±ç»ª**: 96%è¿ç§»å®Œæˆï¼Œå¯ç›´æ¥ä½¿ç”¨

### é€‚ç”¨åœºæ™¯

- âœ… è‡ªåŠ¨é©¾é©¶åœ¨çº¿åœ°å›¾æ„å»º
- âœ… å¤šä¼ æ„Ÿå™¨èåˆï¼ˆå›¾åƒ+LiDARï¼‰
- âœ… å®æ—¶çŸ¢é‡åŒ–æ„ŸçŸ¥
- âœ… å­¦æœ¯ç ”ç©¶å’Œå·¥ä¸šåº”ç”¨

### ä¸‹ä¸€æ­¥å»ºè®®

1. **å‡†å¤‡æ•°æ®**: æŒ‰ç…§READMEç»„ç»‡Argoverse2æˆ–NuScenesæ•°æ®
2. **éªŒè¯ç¯å¢ƒ**: è¿è¡Œ `verify_installation.py`
3. **å¼€å§‹è®­ç»ƒ**: ä½¿ç”¨ç¤ºä¾‹é…ç½®æ–‡ä»¶å¼€å§‹å®éªŒ
4. **æ€§èƒ½è°ƒä¼˜**: æ ¹æ®ä»»åŠ¡è°ƒæ•´è¶…å‚æ•°
5. **è‡ªå®šä¹‰æ‰©å±•**: æ·»åŠ æ–°çš„éª¨å¹²ç½‘ç»œæˆ–æŸå¤±å‡½æ•°ï¼ˆå¦‚éœ€è¦ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2024-12-09  
**ä»£ç ç‰ˆæœ¬**: OpenMMLab 2.0 (MMDetection3D 1.4.0)  
**åˆ†æå®Œæˆåº¦**: å®Œæ•´æ·±åº¦åˆ†æ

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–OpenMMLabå®˜æ–¹æ–‡æ¡£ã€‚
